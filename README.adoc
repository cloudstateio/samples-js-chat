= Friends & Presence service - part of Cloudstate Chat sample
Lightbend, 2020
Version 2.0, 2020-06-22
:description: Friends and Presence stateful services, part of the Cloudstate chat sample https://github.com/cloudstateio/samples-ui-chat
:keywords: Cloudstate, stateful serverless, chat-sample
:sectnums:
:toc:
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Overview

NOTE: This sample is a work-in-progress, and is not up-to-date with the latest changes in Cloudstate or Lightbend Cloudstate. Please see the https://github.com/cloudstateio/samples-ui-shoppingcart[Shopping Cart samples] for the most recent examples of a Cloudstate app instead.

This is the implementation of the `Friends` and `Presence` services, which are part of https://github.com/cloudstateio/samples-ui-chat[Lightbend Cloudstate Chat Sample]. The code is written in JavaScript and runs as a Node.js server. The screenshot below shows the user interface of the chat application:

image::docs/Cloudstate_Sample_ChatApplication.png[Cloudstate Sample - Chat Application]
{nbsp} +

- <<friends/README.adoc#friends-service-overview,Friends>> is a stateful service, using an https://cloudstate.io/docs/core/current/user/features/crdts.html#crdts-available-in-cloudstate[Observed-Removed Set ORSet CRDT] to store/retrieve the list of friends of a user.

- <<presence/README.adoc#presence-service-overview,Presence>> is a stateful service, using a https://cloudstate.io/docs/core/current/user/features/crdts.html#crdts-available-in-cloudstate[Vote CRDT] to store/retrieve the online status of a user.

== Tutorial

The `Friends` and `Presence` services have no User Interface. In this repository, we build these services and test them using `docker` and `grpcurl`.

A detailed tutorial is described in <<friends/README.adoc#javascript-implementation, JavaScript implementation of the Friends service>>. As the design of these services is quite similar, it is not necessary to repeat for the `Presence` service.

== Deployment

It is at deployment time, when all the services collaborate together that we can really appreciate the true benefits of a serverless deployment model. In particular in terms of their stateful and serverless abilities. By using https://github.com/cloudstateio/cloudstate[Cloudstate] library and deploying on Kubernetes, your services store and retrieve state without requiring you to write any code nor manage any storage.

The deployment is described in details in the https://github.com/cloudstateio/samples-ui-chat[Cloudstate Chat Sample]. The deployment is mentioned as a heads-up showing the big picture of the end result. We don't have yet all the constituants to deploy the entire Chat application.

Our goal here is to build and test the `Friends` and `Presence` services. For now, the first step is to setup the dev environment. We will get to the Chat application deployment after we would have successfully tested these services.


[[js-devenv-setup-for-cloudstate]]
== JavaScript Dev environment setup for Cloudstate

=== JavaScript 

* Install https://github.com/nvm-sh/nvm#install--update-script[nvm] (node version manager)
** Check with `nvm --version`, version 0.34.0+ recommended
* Install https://www.npmjs.com/get-npm[npm] (node package manager)
** Check with `npm -v`, version 6.14.3+ recommended
* Install the protobuf compiler.
    ** Check with `protoc --version`, version 3.0.0+ recommended
    ** Mac OS X `brew install protobuf`
    ** Linux `sudo apt install protobuf-compiler`
    ** Or https://developers.google.com/protocol-buffers/docs/downloads[alternatively] (src and bins)


=== Docker

* Install https://www.docker.com/get-started[Docker]
** Check with `docker version`, version v19.03+ is recommended

=== gRPCurl for testing gRPC servers

The communication between the Cloudstate `user-function` uses the gRPC protocol. https://github.com/fullstorydev/grpcurl[gRPCurl] is a command-line tool allowing to query gRPC servers in the same fashion as `curl` with REST servers. 

https://github.com/fullstorydev/grpcurl#installation[Install gRPCurl] from `brew` if you are on macOS or directly from binaries for other OS. If the installation is successful, you should be able to invoke `grpcurl -version` in a terminal:

[source,shell]
----
$ grpcurl -version
grpcurl 1.6.0
----
